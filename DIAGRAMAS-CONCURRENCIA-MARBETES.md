# Diagramas Visuales - Concurrencia en GeneraciÃ³n de Marbetes

---

## Diagrama 1: Arquitectura de ProtecciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PETICIÃ“N DE USUARIO                              â”‚
â”‚                                                                     â”‚
â”‚  POST /api/labels/generate-batch-list                              â”‚
â”‚  {periodId: 123, warehouseId: 456, products: [...]}               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CAPA DE APLICACIÃ“N (JVM)                          â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ LabelServiceImpl.generateBatchList()                         â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚ â”‚ for (ProductBatchDTO product : dto.getProducts()) {   â”‚   â”‚  â”‚
â”‚  â”‚ â”‚     int cantidad = product.getLabelsToGenerate();     â”‚   â”‚  â”‚
â”‚  â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚     â”‚ â¬‡ï¸ OPERACIÃ“N CRÃTICA â¬‡ï¸                       â”‚  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚     â”‚                                              â”‚  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚     â”‚ long[] range =                               â”‚  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚     â”‚ persistence.allocateFolioRange(              â”‚  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚     â”‚     periodId,                                â”‚  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚     â”‚     cantidad                                 â”‚  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚     â”‚ );                                           â”‚  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚     // AQUÃ ES DONDE OCURRE LA MAGIA ğŸ©âœ¨             â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ }                                                      â”‚   â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ADAPTER - LabelsPersistenceAdapter                          â”‚
â”‚                                                                     â”‚
â”‚  @Transactional                                                    â”‚
â”‚  public synchronized long[] allocateFolioRange(                   â”‚
â”‚      Long periodId,                                                â”‚
â”‚      int quantity                                                  â”‚
â”‚  ) { â† SINCRONIZADO A NIVEL JVM                                    â”‚
â”‚      ...                                                            â”‚
â”‚  }                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           REPOSITORIO JPA - PERSISTENCIA                            â”‚
â”‚                                                                     â”‚
â”‚  @Lock(LockModeType.PESSIMISTIC_WRITE) â† BLOQUEO BD               â”‚
â”‚  Optional<LabelFolioSequence> findById(Long id);                  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Cuando se ejecuta:                                          â”‚ â”‚
â”‚  â”‚ â”œâ”€ Obtiene LOCK EXCLUSIVO en la BD                         â”‚ â”‚
â”‚  â”‚ â”œâ”€ Otros procesos NO PUEDEN acceder                        â”‚ â”‚
â”‚  â”‚ â”œâ”€ Lee el valor actual: ultimoFolio                        â”‚ â”‚
â”‚  â”‚ â”œâ”€ Calcula nuevo rango                                     â”‚ â”‚
â”‚  â”‚ â”œâ”€ Actualiza ultimoFolio                                   â”‚ â”‚
â”‚  â”‚ â””â”€ Libera el LOCK cuando termina @Transactional            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BASE DE DATOS MYSQL                              â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Tabla: label_folio_sequence                                 â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚ â”‚
â”‚  â”‚ â”‚ period_idâ”‚ ultimoFolio  â”‚ LOCK     â”‚                      â”‚ â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚ â”‚
â”‚  â”‚ â”‚ 123      â”‚ 5150 (=5000) â”‚ ğŸ”’ WRITE â”‚ â† BLOQUEO EXCLUSIVO â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Tabla: labels                                               â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚ â”‚ folio  â”‚ period_idâ”‚ warehouse â”‚ product_id â”‚              â”‚ â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚ â”‚
â”‚  â”‚ â”‚ 5001   â”‚ 123      â”‚ 456       â”‚ 1001       â”‚              â”‚ â”‚
â”‚  â”‚ â”‚ 5002   â”‚ 123      â”‚ 456       â”‚ 1001       â”‚ â† INSERTADOS â”‚ â”‚
â”‚  â”‚ â”‚ ...    â”‚ 123      â”‚ 456       â”‚ 1001       â”‚              â”‚ â”‚
â”‚  â”‚ â”‚ 5100   â”‚ 123      â”‚ 456       â”‚ 1001       â”‚              â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Diagrama 2: Flujo de Concurrencia Paso a Paso

```
                    TIEMPO â†’
                    
t=0ms    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ESTADO INICIAL: ultimoFolio = 5000                          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

t=100ms  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ğŸ‘¤ USER A (Thread 1):                                       â”‚
         â”‚    generateBatchList(periodId=123, products=[100 labels])   â”‚
         â”‚    âœ“ Entra a allocateFolioRange()                           â”‚
         â”‚      âœ“ Adquiere synchronized âœ“                              â”‚
         â”‚      âœ“ Lee ultimoFolio = 5000                               â”‚
         â”‚      âœ“ Calcula [5001-5100]                                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

t=105ms  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ğŸ‘¤ USER B (Thread 2):                                       â”‚
         â”‚    generateBatchList(periodId=123, products=[50 labels])    â”‚
         â”‚    âœ“ Intenta entra a allocateFolioRange()                   â”‚
         â”‚      âŒ synchronized estÃ¡ en uso por User A                 â”‚
         â”‚      â³ ESPERA EN COLA                                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

t=110ms  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ğŸ‘¤ USER C (Thread 3):                                       â”‚
         â”‚    generateBatchList(periodId=123, products=[75 labels])    â”‚
         â”‚    âœ“ Intenta entra a allocateFolioRange()                   â”‚
         â”‚      âŒ synchronized estÃ¡ en uso por User A                 â”‚
         â”‚      â³ ESPERA EN COLA (detrÃ¡s de User B)                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

t=120ms  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ğŸ‘¤ USER A (Thread 1):                                       â”‚
         â”‚    Dentro de allocateFolioRange():                          â”‚
         â”‚    â”œâ”€ @Lock(PESSIMISTIC_WRITE) en BD âœ“ (consigue lock)     â”‚
         â”‚    â”œâ”€ Read: ultimoFolio = 5000                              â”‚
         â”‚    â”œâ”€ Calculate: [5001-5100]                                â”‚
         â”‚    â”œâ”€ Update: ultimoFolio = 5100                            â”‚
         â”‚    â”œâ”€ Commit & Release lock âœ“                              â”‚
         â”‚    â””â”€ Return [5001-5100]                                    â”‚
         â”‚                                                             â”‚
         â”‚    âœ“ Retorna de allocateFolioRange()                        â”‚
         â”‚    âœ“ Libera synchronized âœ“                                  â”‚
         â”‚    âœ“ Crea 100 objetos Label                                â”‚
         â”‚    âœ“ persistence.saveAll(labels)                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

t=125ms  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ğŸ‘¤ USER B (Thread 2):                                       â”‚
         â”‚    âœ“ FINALMENTE: Adquiere synchronized âœ“                    â”‚
         â”‚    Dentro de allocateFolioRange():                          â”‚
         â”‚    â”œâ”€ @Lock(PESSIMISTIC_WRITE) en BD âœ“ (consigue lock)     â”‚
         â”‚    â”œâ”€ Read: ultimoFolio = 5100 (actualizado por A)         â”‚
         â”‚    â”œâ”€ Calculate: [5101-5150]                                â”‚
         â”‚    â”œâ”€ Update: ultimoFolio = 5150                            â”‚
         â”‚    â”œâ”€ Commit & Release lock âœ“                              â”‚
         â”‚    â””â”€ Return [5101-5150]                                    â”‚
         â”‚                                                             â”‚
         â”‚    âœ“ Retorna de allocateFolioRange()                        â”‚
         â”‚    âœ“ Libera synchronized âœ“                                  â”‚
         â”‚    âœ“ Crea 50 objetos Label                                 â”‚
         â”‚    âœ“ persistence.saveAll(labels)                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

t=150ms  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ğŸ‘¤ USER C (Thread 3):                                       â”‚
         â”‚    âœ“ FINALMENTE: Adquiere synchronized âœ“                    â”‚
         â”‚    Dentro de allocateFolioRange():                          â”‚
         â”‚    â”œâ”€ @Lock(PESSIMISTIC_WRITE) en BD âœ“ (consigue lock)     â”‚
         â”‚    â”œâ”€ Read: ultimoFolio = 5150 (actualizado por B)         â”‚
         â”‚    â”œâ”€ Calculate: [5151-5225]                                â”‚
         â”‚    â”œâ”€ Update: ultimoFolio = 5225                            â”‚
         â”‚    â”œâ”€ Commit & Release lock âœ“                              â”‚
         â”‚    â””â”€ Return [5151-5225]                                    â”‚
         â”‚                                                             â”‚
         â”‚    âœ“ Retorna de allocateFolioRange()                        â”‚
         â”‚    âœ“ Libera synchronized âœ“                                  â”‚
         â”‚    âœ“ Crea 75 objetos Label                                 â”‚
         â”‚    âœ“ persistence.saveAll(labels)                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

t=200ms  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ âœ… RESULTADO FINAL:                                         â”‚
         â”‚                                                             â”‚
         â”‚ BD Estado:                                                 â”‚
         â”‚ â”œâ”€ ultimoFolio = 5225                                      â”‚
         â”‚ â”œâ”€ Total marbetes = 225                                    â”‚
         â”‚                                                             â”‚
         â”‚ DistribuciÃ³n:                                              â”‚
         â”‚ â”œâ”€ User A: 5001-5100 (100 marbetes)                       â”‚
         â”‚ â”œâ”€ User B: 5101-5150 (50 marbetes)                        â”‚
         â”‚ â””â”€ User C: 5151-5225 (75 marbetes)                        â”‚
         â”‚                                                             â”‚
         â”‚ GarantÃ­as:                                                â”‚
         â”‚ âœ… SIN DUPLICADOS                                          â”‚
         â”‚ âœ… CONTINUIDAD PERFECTA                                    â”‚
         â”‚ âœ… ORDEN RESPETADO                                         â”‚
         â”‚ âœ… COMPLETADO EN 200ms (muy rÃ¡pido)                        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Diagrama 3: Queue de SincronizaciÃ³n

```
                    COLA DE allocateFolioRange()
                    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         synchronized long[] allocateFolioRange()   â”‚
â”‚                                                    â”‚
â”‚  SLOT ÃšNICO - Solo uno a la vez                   â”‚
â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ğŸ‘¤ EJECUTANDO AHORA               â”‚             â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚             â”‚
â”‚  â”‚ â”‚ User A (periodo 123, qty 100) â”‚â”‚             â”‚
â”‚  â”‚ â”‚ Duration: 20ms                 â”‚â”‚             â”‚
â”‚  â”‚ â”‚ Return: [5001-5100] âœ“          â”‚â”‚             â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚           â¬‡ï¸ (20ms despuÃ©s)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ğŸ‘¤ EJECUTANDO AHORA               â”‚             â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚             â”‚
â”‚  â”‚ â”‚ User B (periodo 123, qty 50)  â”‚â”‚             â”‚
â”‚  â”‚ â”‚ Duration: 15ms                 â”‚â”‚             â”‚
â”‚  â”‚ â”‚ Return: [5101-5150] âœ“          â”‚â”‚             â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚           â¬‡ï¸ (15ms despuÃ©s)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ğŸ‘¤ EJECUTANDO AHORA               â”‚             â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚             â”‚
â”‚  â”‚ â”‚ User C (periodo 123, qty 75)  â”‚â”‚             â”‚
â”‚  â”‚ â”‚ Duration: 18ms                 â”‚â”‚             â”‚
â”‚  â”‚ â”‚ Return: [5151-5225] âœ“          â”‚â”‚             â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                    â”‚
â”‚  ESPERA (Si 4Âº usuario llega aquÃ­)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ â³ ESPERANDO...                    â”‚             â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚             â”‚
â”‚  â”‚ â”‚ User D (periodo 123, qty 60)  â”‚â”‚             â”‚
â”‚  â”‚ â”‚ Waiting... 2ms                 â”‚â”‚             â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KEY:
â”œâ”€ Solo UN usuario a la vez
â”œâ”€ DuraciÃ³n: ~15-20ms por usuario
â”œâ”€ MÃ¡ximo espera: depende del orden
â””â”€ NUNCA hay race condition
```

---

## Diagrama 4: Bloqueo BD (PESSIMISTIC_WRITE)

```
                  BLOQUEO EN BASE DE DATOS
                  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tabla: label_folio_sequence                           â”‚
â”‚                                                        â”‚
â”‚  period_id â”‚ ultimoFolio â”‚ LOCK_STATUS                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚     123    â”‚    5150     â”‚  ğŸ”’ WRITE LOCKED          â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Usuario A - TIENE EL LOCK (exclusivo)            â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ âœ“ Lee: ultimoFolio = 5000                        â”‚ â”‚
â”‚  â”‚ âœ“ Calcula: [5001-5100]                           â”‚ â”‚
â”‚  â”‚ âœ“ Actualiza: ultimoFolio = 5100                  â”‚ â”‚
â”‚  â”‚ âœ“ COMMIT â†’ Libera LOCK                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Usuario B - ESPERANDO EL LOCK                    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ â³ Intenta: findById(123)                        â”‚ â”‚
â”‚  â”‚ â³ Solicita PESSIMISTIC_WRITE                     â”‚ â”‚
â”‚  â”‚ â³ BLOQUEADO por Usuario A                       â”‚ â”‚
â”‚  â”‚ â³ Espera a que A libere (timeout: 30s)         â”‚ â”‚
â”‚  â”‚ âœ“ Obtiene LOCK cuando A termina                 â”‚ â”‚
â”‚  â”‚ âœ“ Lee: ultimoFolio = 5100                        â”‚ â”‚
â”‚  â”‚ âœ“ Calcula: [5101-5150]                           â”‚ â”‚
â”‚  â”‚ âœ“ Actualiza: ultimoFolio = 5150                  â”‚ â”‚
â”‚  â”‚ âœ“ COMMIT â†’ Libera LOCK                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Usuario C - ESPERANDO EL LOCK                    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ â³ Intenta: findById(123)                        â”‚ â”‚
â”‚  â”‚ â³ Solicita PESSIMISTIC_WRITE                     â”‚ â”‚
â”‚  â”‚ â³ BLOQUEADO por Usuario B (que tiene LOCK)     â”‚ â”‚
â”‚  â”‚ â³ Espera a que B libere                        â”‚ â”‚
â”‚  â”‚ âœ“ Obtiene LOCK cuando B termina                 â”‚ â”‚
â”‚  â”‚ âœ“ Lee: ultimoFolio = 5150                        â”‚ â”‚
â”‚  â”‚ âœ“ Calcula: [5151-5225]                           â”‚ â”‚
â”‚  â”‚ âœ“ Actualiza: ultimoFolio = 5225                  â”‚ â”‚
â”‚  â”‚ âœ“ COMMIT â†’ Libera LOCK                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                        â”‚
â”‚  GARANTÃAS:                                            â”‚
â”‚  â”œâ”€ Nunca dos usuarios leen el mismo valor             â”‚
â”‚  â”œâ”€ Cada usuario ve el valor actualizado              â”‚
â”‚  â”œâ”€ Los folios nunca se repiten                       â”‚
â”‚  â””â”€ Continuidad garantizada                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Diagrama 5: Matriz de DecisiÃ³n (Â¿QuÃ© pasa si...?)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MATRIZ DE DECISIÃ“N - ESCENARIOS                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£  2 usuarios, 1 servidor, 100 marbetes cada uno
    â”œâ”€ synchronized: âœ“ Funciona (en la misma JVM)
    â”œâ”€ PESSIMISTIC_WRITE: âœ“ Funciona (en BD)
    â”œâ”€ Resultado: âœ… Folios Ãºnicos [1-100, 101-200]
    â””â”€ Tiempo: ~50ms

2ï¸âƒ£  10 usuarios, 1 servidor, 50 marbetes cada uno
    â”œâ”€ synchronized: âœ“ Funciona (ejecutan secuencialmente)
    â”œâ”€ PESSIMISTIC_WRITE: âœ“ Funciona (uno por uno)
    â”œâ”€ Resultado: âœ… Folios Ãºnicos [1-50, 51-100, ...]
    â””â”€ Tiempo: ~200ms

3ï¸âƒ£  2 usuarios, 2 SERVIDORES, 100 marbetes cada uno
    â”œâ”€ synchronized: âŒ No funciona (JVMs separadas)
    â”œâ”€ PESSIMISTIC_WRITE: âœ“ Funciona (BD es Ã¡rbitro)
    â”œâ”€ Resultado: âœ… Folios Ãºnicos [1-100, 101-200]
    â””â”€ Tiempo: ~100ms (con latencia de red)

4ï¸âƒ£  BD no responde
    â”œâ”€ synchronized: âœ“ No se alcanza (DB requerida)
    â”œâ”€ PESSIMISTIC_WRITE: âŒ Error de conexiÃ³n
    â”œâ”€ Resultado: âŒ Error HTTP 500
    â””â”€ SoluciÃ³n: Revisar BD

5ï¸âƒ£  Pool de conexiones agotado
    â”œâ”€ synchronized: âœ“ No afectado (no es concurrencia Java)
    â”œâ”€ PESSIMISTIC_WRITE: â³ Timeout esperando conexiÃ³n
    â”œâ”€ Resultado: â³ Timeout after 20s
    â””â”€ SoluciÃ³n: Aumentar pool size

6ï¸âƒ£  Lock timeout en BD
    â”œâ”€ synchronized: âœ“ No afectado (en JVM)
    â”œâ”€ PESSIMISTIC_WRITE: â³ Espera 30s (default)
    â”œâ”€ Resultado: âŒ Error "Lock wait timeout exceeded"
    â””â”€ SoluciÃ³n: Revisar quÃ© bloquea la BD
```

---

## Diagrama 6: Flujo de Control (PseudocÃ³digo)

```
function generateBatchList(dto: GenerateBatchListDTO) {
    // PASO 1: Validar acceso
    validateWarehouseAccess(userId, warehouseId)
    â”Œâ”€ Si falla: throw UnauthorizedAccessException âœ—
    
    // PASO 2: Procesar cada producto
    for each productBatch in dto.products {
        
        // ğŸ”´ OPERACIÃ“N CRÃTICA - AQUÃ OCURRE LA MAGIA
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Entrar a allocateFolioRange():              â”‚
        â”‚                                             â”‚
        â”‚ 1ï¸âƒ£  Adquirir synchronized en JVM            â”‚
        â”‚    â””â”€ Si otro thread estÃ¡: ESPERAR         â”‚
        â”‚                                             â”‚
        â”‚ 2ï¸âƒ£  Comenzar @Transactional                â”‚
        â”‚                                             â”‚
        â”‚ 3ï¸âƒ£  Ejecutar findById(periodId):           â”‚
        â”‚    â”œâ”€ Solicitar @Lock(PESSIMISTIC_WRITE)   â”‚
        â”‚    â”œâ”€ Si otro tiene lock: ESPERAR (en BD)  â”‚
        â”‚    â”œâ”€ Leer ultimoFolio                     â”‚
        â”‚    â””â”€ Devolver LabelFolioSequence          â”‚
        â”‚                                             â”‚
        â”‚ 4ï¸âƒ£  Calcular rango:                        â”‚
        â”‚    â”œâ”€ primer = ultimoFolio + 1             â”‚
        â”‚    â””â”€ ultimo = ultimoFolio + cantidad      â”‚
        â”‚                                             â”‚
        â”‚ 5ï¸âƒ£  Actualizar la secuencia:               â”‚
        â”‚    â””â”€ ultimoFolio = ultimo                 â”‚
        â”‚                                             â”‚
        â”‚ 6ï¸âƒ£  Guardar (update):                      â”‚
        â”‚    â””â”€ jpaLabelFolioSequenceRepository.save()
        â”‚                                             â”‚
        â”‚ 7ï¸âƒ£  Finalizar @Transactional:              â”‚
        â”‚    â”œâ”€ Commit âœ“                              â”‚
        â”‚    â””â”€ Release @Lock (PESSIMISTIC_WRITE)    â”‚
        â”‚                                             â”‚
        â”‚ 8ï¸âƒ£  Liberar synchronized                   â”‚
        â”‚                                             â”‚
        â”‚ RETORNA: long[] = [primer, ultimo]          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        
        // PASO 3: Crear objetos Label
        labels[] = {
            new Label{folio: primer, ...}
            new Label{folio: primer+1, ...}
            ...
            new Label{folio: ultimo, ...}
        }
        
        // PASO 4: Guardar en BD (operaciÃ³n rÃ¡pida)
        persistence.saveAll(labels)
    }
    
    // PASO 5: Retornar Ã©xito
    return ResponseEntity.ok({status: 'success'})
}
```

---

**Ãšltima actualizaciÃ³n:** 2026-02-09
**VersiÃ³n:** 1.0

